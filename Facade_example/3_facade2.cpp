﻿#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include <iostream>
#include <WinSock2.h>
#pragma comment(lib, "ws2_32.lib")
using namespace std;

// SRP ( Single Responsibility Principle )
// => 하나의 클래스는 하나의 책임만 있어야 한다.

class NetworkInit
{
public:
    NetworkInit()
    {
        // 1. 네트워크 라이브러리 초기화
        WSADATA w;
        WSAStartup(0x202, &w);
    }
    ~NetworkInit()
    {
        // 6. socket 라이브러리 cleanup
        WSACleanup();
    }
};

// IP 주소를 관리하는 클래스
class IPAddress
{
    SOCKADDR_IN addr;
public:
    IPAddress(const char* ip, short port)
    {
        addr.sin_family = AF_INET;
        addr.sin_port = htons(port);
        addr.sin_addr.s_addr = inet_addr(ip);
    }
    SOCKADDR* getRawAddress()
    {
        return (SOCKADDR*)&addr;
    }
};

// Socket 작업을 책임지는 클래스
class Socket
{
    int sock;
public:
    Socket(int type) { sock = socket(PF_INET, type, 0); }

    void Bind(IPAddress* ip)
    {
        ::bind(sock, ip->getRawAddress(), sizeof(SOCKADDR_IN));
    }
    void Listen() { ::listen(sock, 5); }

    void Accept()
    {
        struct sockaddr_in addr2 = { 0 };
        int sz = sizeof(addr2);

        accept(sock, (SOCKADDR*)&addr2, &sz);
    }
};

// 라이브러리 설계자들이 위처럼 만들어 주면
// 최종사용자는 아래 처럼 사용합니다.
// facade1.cpp 보다는 아주 간결합니다.
// => 객체지향의 장점

int main()
{
    NetworkInit init;

    Socket sock(SOCK_STREAM); // TCP 서버

    IPAddress addr("127.0.0.1", 4000);
    sock.Bind(&addr);
    sock.Listen();
    sock.Accept();

}